# ADR: usersコレクションの読み取り権限を全体公開

## ステータス
Accepted (2026-01-20)

## コンテキスト
ランキングページの実装において、未ログインユーザーでも上位50名のプレイヤーランキング（rating, total_matches, display_name, photo_url）を閲覧できるようにする必要があった。

Firestoreのセキュリティルールでは、ドキュメント全体の読み取り権限しか制御できず、**特定のフィールドだけを公開**することは直接できない。

## 検討した選択肢

### 選択肢1: 公開用コレクションを分離
`users_public`という別コレクションを作成し、公開情報のみを保存する。
- **メリット**: セキュアで明確、非公開情報を確実に保護できる
- **デメリット**: データ同期の実装が必要（プロフィール更新時に両方更新）、データ重複

### 選択肢2: Cloud Functionsで専用エンドポイント
HTTPSエンドポイントを作成し、必要なフィールドだけを返す。
- **メリット**: データ構造を変更不要、柔軟な制御
- **デメリット**: Functions実装が必要、リアルタイム性が低い、追加コスト

### 選択肢3: usersコレクション全体を公開（採用）
現在のusersコレクションの読み取り権限を全体公開する。
- **メリット**: 実装がシンプル、リアルタイム性が高い、追加実装不要
- **デメリット**: リアルタイム状態やペナルティ情報も公開される

## 決定内容
**選択肢3を採用**: usersコレクションの読み取り権限を`allow read: true`に設定し、全体を公開する。

### 理由
1. **個人情報の問題なし**: emailフィールドは既に使用していない。display_name, photo_urlは本質的に公開情報
2. **公開されるプライバシー情報の評価**:
   - `queue_status`, `queue_joined_at`, `matched_match_id`: リアルタイムの状態情報だが、機密性は低い
   - `banned_until`: ペナルティ情報だが、不正行為への抑止効果もある
   - これらが公開されても、ゲームの性質上、重大な問題にはならないと判断
3. **実装コスト**: フェーズ1.3の範囲内で、シンプルかつ迅速に実装できる
4. **将来的な拡張性**: 必要であれば後からコレクション分離も可能

## 影響

### ポジティブ
- ランキングページを未ログインユーザーに公開可能
- 実装がシンプルで保守性が高い
- リアルタイムデータの取得が可能

### ネガティブ
- 以下の情報が誰でも閲覧可能になる:
  - `queue_status`: キュー中かどうか
  - `queue_joined_at`: キュー参加時刻
  - `matched_match_id`: 現在のマッチID
  - `banned_until`: ペナルティ期限
  - `recent_results`: 直近20試合の詳細（勝敗、レート変動）

### セキュリティ考察
- **更新権限は保護**: 本人のみが自分のドキュメントを更新可能（認証必須）
- **機密情報なし**: クレデンシャルや個人識別情報（PII）は含まれていない
- **ペナルティの透明性**: banned_untilが公開されることで、ペナルティの透明性が向上

## 実装ファイル
- `firestore.rules`: users/{userId} の `allow read: true` に変更
- `src/features/ranking/RankingPage.tsx`: 認証不要でランキングデータを取得

## 将来の検討事項
もしプライバシー要件が厳しくなった場合は、選択肢1（公開用コレクション分離）への移行を検討する。
