rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ユーザーコレクション
    match /users/{userId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId
        && (
          // プロフィール等の更新（キュー関連およびペナルティ関連の変更なし）
          !request.resource.data.diff(resource.data).changedKeys().hasAny([
            "queue_status",
            "queue_joined_at",
            "matched_match_id",
            "banned_until",
            "rating"
          ])
          ||
          // キュー開始/キャンセルはクライアントから許可（matchedは不可）
          (
            request.resource.data.queue_status in ["waiting", null]
            && request.resource.data.matched_match_id == null
            && (
              (request.resource.data.queue_status == "waiting"
                && request.resource.data.queue_joined_at is timestamp)
              ||
              (request.resource.data.queue_status == null
                && request.resource.data.queue_joined_at == null)
            )
          )
        );

      // penalties サブコレクション
      match /penalties/{penaltyId} {
        // 読み取り: 本人のみ
        allow read: if request.auth != null && request.auth.uid == userId;
        // 作成・更新・削除: バックエンドのみ
        allow create, update, delete: if false;
      }

      // notifications サブコレクション
      match /notifications/{notificationId} {
        // 読み取り: 本人のみ
        allow read: if request.auth != null && request.auth.uid == userId;
        // 更新: 本人のみ（readフラグのみ変更可能）
        allow update: if request.auth != null && request.auth.uid == userId
          && request.resource.data.diff(resource.data).changedKeys().hasOnly(["read"]);
        // 作成・削除: バックエンドのみ
        allow create, delete: if false;
      }
    }

    // matches コレクション
    match /matches/{matchId} {
      // 認証済みユーザーは読み取り可能
      allow read: if request.auth != null;

      // 作成: 認証済みユーザーのみ（フェーズ1: 手動作成ドラフト用）
      allow create: if request.auth != null
        && request.resource.data.status == "waiting"
        && request.resource.data.created_at is timestamp;

      // 更新: ステータス遷移のみ許可（waiting -> draft_pending）
      allow update: if request.auth != null
        && resource.data.status == "waiting"
        && request.resource.data.status == "draft_pending";

      // 削除は禁止
      allow delete: if false;

      // members サブコレクション
      match /members/{memberId} {
        allow read: if request.auth != null;

        // 作成: 自分自身のメンバードキュメントのみ作成可能
        allow create: if request.auth != null
          && request.auth.uid == memberId
          && request.resource.data.user_id == request.auth.uid
          && request.resource.data.role in ["participant", "spectator"];

        // 更新: 自分自身のみ許可
        allow update: if request.auth != null
          && request.auth.uid == memberId
          && resource.data.user_id == request.auth.uid
          && request.resource.data.user_id == request.auth.uid
          && request.resource.data.role == resource.data.role
          && (
            // waiting時: 座席移動許可
            get(/databases/$(database)/documents/matches/$(matchId)).data.status == "waiting"
            ||
            // lobby_pending時: 困り中フィールドのみ許可
            // 注: seated_atはCallable経由で更新するため、クライアント直接更新は不要
            (
              get(/databases/$(database)/documents/matches/$(matchId)).data.status == "lobby_pending"
              && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                "lobby_issue",
                "lobby_issue_at",
                "lobby_creating",
                "lobby_creating_at",
                "match_result",
                "match_left_at"
              ])
            )
          );

        // 削除: 自分自身のみ退出可能
        allow delete: if request.auth != null
          && request.auth.uid == memberId;
      }

      // reports サブコレクション（通報）
      match /reports/{reportId} {
        // 読み取り: マッチ参加者のみ
        allow read: if request.auth != null
          && exists(/databases/$(database)/documents/matches/$(matchId)/members/$(request.auth.uid));

        // 作成: マッチ参加者のみ、自己通報禁止
        // reason: "no_show", "troll", "other" のいずれか
        // reason が "other" の場合は reason_detail が必須
        allow create: if request.auth != null
          && exists(/databases/$(database)/documents/matches/$(matchId)/members/$(request.auth.uid))
          && request.resource.data.reporter_user_id == request.auth.uid
          && request.resource.data.reported_user_id != request.auth.uid
          && exists(/databases/$(database)/documents/matches/$(matchId)/members/$(request.resource.data.reported_user_id))
          && request.resource.data.reason in ["no_show", "troll", "other"]
          && (request.resource.data.reason != "other" ||
              (request.resource.data.reason_detail is string && request.resource.data.reason_detail.size() > 0))
          && request.resource.data.match_id == matchId
          && request.resource.data.match_created_at is timestamp
          && request.resource.data.reported_at is timestamp;

        // 更新・削除は禁止
        allow update, delete: if false;
      }
    }

    // draft_sessions コレクション
    match /draft_sessions/{draftId} {
      // 読み取りは認証済みユーザーのみ
      allow read: if request.auth != null;

      // 作成は認証済みユーザーのみ（フィールドバリデーション）
      // match_idで指定されたマッチが存在し、waiting状態であることを確認
      allow create: if request.auth != null
        && request.resource.data.source_type == "match"
        && request.resource.data.status == "waiting"
        && request.resource.data.match_id is string
        && exists(/databases/$(database)/documents/matches/$(request.resource.data.match_id))
        && get(/databases/$(database)/documents/matches/$(request.resource.data.match_id)).data.status == "waiting";

      // 更新は禁止（status変更は将来のフェーズで実装）
      allow update: if false;

      // turns サブコレクション
      match /turns/{turnId} {
        allow read: if request.auth != null;
        // 作成は認証済みユーザーのみ、親のdraft_sessionが存在することを確認
        allow create: if request.auth != null
          && exists(/databases/$(database)/documents/draft_sessions/$(draftId));
        // 更新・削除は禁止
        allow update, delete: if false;
      }
    }

  }
}
