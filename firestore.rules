rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ユーザーコレクション
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId
        && (
          // プロフィール等の更新（キュー関連の変更なし）
          !request.resource.data.diff(resource.data).changedKeys().hasAny([
            "queue_status",
            "queue_joined_at",
            "matched_match_id"
          ])
          ||
          // キュー開始/キャンセルはクライアントから許可（matchedは不可）
          (
            request.resource.data.queue_status in ["waiting", null]
            && request.resource.data.matched_match_id == null
            && (
              (request.resource.data.queue_status == "waiting"
                && request.resource.data.queue_joined_at is timestamp)
              ||
              (request.resource.data.queue_status == null
                && request.resource.data.queue_joined_at == null)
            )
          )
        );
    }

    // matches コレクション
    match /matches/{matchId} {
      // 認証済みユーザーは読み取り可能
      allow read: if request.auth != null;

      // 作成: 認証済みユーザーのみ（フェーズ1: 手動作成ドラフト用）
      allow create: if request.auth != null
        && request.resource.data.status == "waiting"
        && request.resource.data.created_at is timestamp;

      // 更新: ステータス遷移のみ許可（waiting -> draft_pending）
      allow update: if request.auth != null
        && resource.data.status == "waiting"
        && request.resource.data.status == "draft_pending";

      // 削除は禁止
      allow delete: if false;

      // members サブコレクション
      match /members/{memberId} {
        allow read: if request.auth != null;

        // 作成: 自分自身のメンバードキュメントのみ作成可能
        allow create: if request.auth != null
          && request.auth.uid == memberId
          && request.resource.data.user_id == request.auth.uid
          && request.resource.data.role in ["participant", "spectator"];

        // 更新: 自分自身の座席移動のみ許可（team, seat_noの変更）
        allow update: if request.auth != null
          && request.auth.uid == memberId
          && resource.data.user_id == request.auth.uid
          && request.resource.data.user_id == request.auth.uid
          && request.resource.data.role == resource.data.role;

        // 削除: 自分自身のみ退出可能
        allow delete: if request.auth != null
          && request.auth.uid == memberId;
      }
    }

    // draft_sessions コレクション
    match /draft_sessions/{draftId} {
      // 読み取りは認証済みユーザーのみ
      allow read: if request.auth != null;

      // 作成は認証済みユーザーのみ（フィールドバリデーション）
      // match_idで指定されたマッチが存在し、waiting状態であることを確認
      allow create: if request.auth != null
        && request.resource.data.source_type == "match"
        && request.resource.data.status == "waiting"
        && request.resource.data.match_id is string
        && exists(/databases/$(database)/documents/matches/$(request.resource.data.match_id))
        && get(/databases/$(database)/documents/matches/$(request.resource.data.match_id)).data.status == "waiting";

      // 更新は禁止（status変更は将来のフェーズで実装）
      allow update: if false;

      // turns サブコレクション
      match /turns/{turnId} {
        allow read: if request.auth != null;
        // 作成は認証済みユーザーのみ、親のdraft_sessionが存在することを確認
        allow create: if request.auth != null
          && exists(/databases/$(database)/documents/draft_sessions/$(draftId));
        // 更新・削除は禁止
        allow update, delete: if false;
      }
    }
  }
}
