# ユナメイト 要件定義書（フェーズ別ロードマップ版・確定＋フェーズ3席仕様）

## 0. 本書の目的

本書は、ユナメイトを段階的に開発するために、要件を「フェーズ1（MVP）」「フェーズ2（拡張）」「フェーズ3（モジュール化）」に分けて整理する。
フェーズ1は“まず遊べること”を最優先し、フェーズ2で競技性・継続性（成績/レート等）を追加し、フェーズ3でドラフトピック機能を単体利用できるモジュールとして提供する。

---

## 1. プロダクト概要

### 1.1 ユナメイトとは

ポケモンユナイトのドラフトピック形式のマッチを、アプリでマッチング・ドラフト進行し、試合自体はゲーム内（アプリ外）で行うシステム。

### 1.2 スコープ（共通）

* 対象：10人（5vs5）
* アプリ内：キュー、マッチング、ドラフト（BAN/PICK）、ロビーID共有
* アプリ外：ゲーム内ロビー作成・参加・試合実施

---

## 2. フェーズ定義（大枠）

### フェーズ1（MVP）：ランダムマッチ版

* レーティングなし
* 試合結果の報告・集計なし
* 「マッチング→ドラフト→ロビーID共有→試合開始」までを成立させる

### フェーズ2（拡張）：ランクマッチ版

* レーティング（Elo）あり
* 試合結果入力→多数決確定→バッチ反映あり
* ランキング/統計を本格導入
* ノーショー等のペナルティ運用

### フェーズ3（拡張）：ドラフトピックのモジュール化（Draft Module）

* 目的：マッチングを経由せず、固定メンバー（スクリム等）で「ドラフトピックだけ」を実施できるようにする
* 「誰かがルームを作り、10人集まったらドラフト開始」できる機能を追加する
* フェーズ1/2の「マッチング後ドラフト」は、このモジュールを途中に挟む形式にリファクタリングする（= マッチングシステムとドラフトシステムを疎結合にする）

---

## 3. 共通要件（フェーズ1・2共通）

### 3.1 基本フロー（共通：フェーズ1/2）

1. ユーザー登録/ログイン
2. インキュー
3. 10人でマッチ成立
4. ドラフト（BAN→PICK）
5. ホスト抽選
6. ホストがロビーID入力
7. 全員がロビーIDを見てゲーム内で参加し試合開始

### 3.2 マッチング実行条件（共通）

以下いずれかでマッチングを実行する。

* キュー人数が30人以上になった
* 先頭のキュー参加から3分が経過した

マッチング実行時は、できるだけ多くの試合を一度に生成する（例：30人なら3試合）。

---

## 4. ドラフト要件（共通：BAN/PICKで同一ルールを適用）

### 4.1 ルール

* BAN：3BAN制（各チーム3、計6）
* BAN順：先攻→後攻→先攻→後攻→先攻→後攻（各ターン1BAN）
* PICK順：先攻1 → 後攻2 → 先攻2 → 後攻2 → 先攻2 → 後攻1
* 重複禁止

  * BAN：両チーム跨いで同一ポケモンBAN不可
  * PICK：同一試合で同一ポケモンは1回のみ（10体ユニーク）
* 制限時間：各BAN/各PICK 15秒
* ターン開始通知：サーバは `turn_started(turn_id, deadline_at, server_now)` をターン開始時に1回配信（逐次配信しない）

### 4.2 操作UI（BAN/PICK共通）

* クリック→確定ボタンの2段階方式
* 確定前はクリックを何度でも変更可能
* 確定後の取り消しは不可

### 4.3 自動確定（BAN/PICK共通）

* 締切後に1秒の猶予を設ける（遅延吸収）
* 締切+1秒までに「最後のクリック情報」がサーバに到達していれば、それで確定
* クリック情報がなければ、空いているポケモンからランダムで確定
* 自動確定はペナルティ対象外（不利になること自体が実質ペナルティ）

---

## 5. BAN担当とBANリクエスト（共通）

### 5.1 BAN担当者の決定

* 各BANターンの担当者は、当該チーム内からランダムに決定する

### 5.2 BANリクエスト/承認（承認＝確定）

* 目的：担当者以外のチームメンバーがBAN提案し、担当者が承認してBAN確定できるようにする
* リクエスト：

  * 担当者以外のチームメンバーなら誰でもリクエスト可能
  * リクエスト者は、BANしたいポケモンを選んだ上でリクエストを送信する
  * リクエスト内容（ポケモン）はチーム内にブロードキャストされ、全員が閲覧できる
* 承認：

  * 承認できるのは本来のBAN担当者のみ
  * 1ターン内で承認できるリクエストは1つだけ
  * 承認された瞬間に、そのリクエストのポケモンでBANが確定する（承認＝確定）
* リクエスト有効期限：そのターン終了まで

---

## 6. PICK担当とPICK譲渡（共通）

### 6.1 PICK担当者の決定

* 各PICK枠の担当者は、当該チーム内からランダムに決定する
* 原則、担当者は「自分が使うポケモン」を選択する

### 6.2 PICK譲渡（リクエスト/承認：承認＝確定）

* リクエスト：

  * 担当者以外のチームメンバーなら誰でもリクエスト可能
  * リクエスト者は、ポケモンを選んだ上でリクエストを出す
  * リクエスト内容（ポケモン）はチーム内にブロードキャストされ、全員が閲覧できる
* 承認：

  * 承認できるのは本来の担当者のみ
  * 1ターン内で承認できるリクエストは1つだけ
  * 承認された瞬間に、そのリクエストのポケモンで即時確定（承認＝確定）
* リクエストの有効期限：そのターン終了まで

---

## 7. ロビーID共有要件（共通：フェーズ1/2）

* ドラフト完了後、ホストをランダム決定
* ホストのロビーID入力猶予：2分
* 未入力の場合は再抽選（最大1回）
* 再抽選でも未入力の場合は試合無効として解散

---

## 8. フェーズ別要件

### 8.1 フェーズ1（MVP）：ランダムマッチ

* マッチング：キュー内からランダムに10人を抽出
* チーム分け：ランダムに5人ずつ
* 先攻/後攻：ランダム
* 試合結果：報告・集計は行わない（試合後のアプリ操作は不要）

### 8.2 フェーズ2（拡張）：ランクマッチ

#### 8.2.1 マッチング（レートベース）

* レーティング（Elo）を用いる
* マッチング実行時、レートが高い順に参加者を抽出
* チーム分け：高い順に並べて交互に振り分け

  * 先攻：1,3,5,7,9位
  * 後攻：2,4,6,8,10位

#### 8.2.2 試合結果入力・確定・ペナルティ（フェーズ2）

* 試合結果入力（勝ち/負け/無効）、多数決確定、5分バッチ、ノーショー特定、ペナルティ（1時間インキュー禁止）を導入する

#### 8.2.3 レーティング・ランキング・統計（フェーズ2）

* 初期レート1600、Elo、ランキング等を導入する

---

## 9. フェーズ3（Draft Module）要件：ルーム型ドラフト

### 9.1 目的

* マッチング不要で、固定メンバー（スクリム等）で「ドラフトだけ」を実施できるようにする
* ルームを作成し、10人が参加したらドラフトを開始できること

### 9.2 ルーム作成と参加

* ルーム作成者（オーナー）がルームを作成できる
* ルームには参加用の識別子（例：ルームID / 招待コード）を持つ
* ユーザーは識別子を用いてルームに参加できる
* 参加上限は10人
* 10人揃ったらドラフトを開始できる

### 9.3 チーム分け（席ベース）

* ルームには「席」を用意し、ユーザーは入室後に任意の席に着席する
* 席は以下の2陣営に分かれる：

  * 先攻チーム席（5席）
  * 後攻チーム席（5席）
* どの席に座ったかで所属チームが決まる（= チーム分けは席で決定）
* 先攻/後攻も席によって確定する（先攻席に座れば先攻チーム）
* 席は1ユーザー1席、同席不可
* 10席が全て埋まったらドラフト開始可能

### 9.4 ドラフト実行（ルーム）

* ルーム型ドラフトでも、4〜6章の「共通ドラフト要件」をそのまま使用する
* ドラフト結果（BAN/PICKの確定結果）はルーム内で閲覧できる

### 9.5 ルーム終了

* ドラフト完了後、ルームは「完了」状態となる
* ルームを継続利用するか（再ドラフト）/終了するかは将来拡張

---

## 10. フェーズ1/2への組み込み（ドラフトモジュール挟み込み）

### 10.1 アーキテクチャ方針（要件）

* フェーズ3以降、ドラフト機能は「Draft Module」として独立した呼び出し単位とする
* フェーズ1/2のマッチング後ドラフトは、以下の流れに変更する：

  * マッチング成立（10人確定）
    → Draft Moduleに「ドラフトセッション作成（参加者10人、チーム分け、先攻後攻）」を依頼
    → Draft Moduleのドラフト進行UI/ロジックでBAN/PICKを実施
    → ドラフト完了後、フェーズ1/2のフローに復帰（ホスト抽選・ロビーID入力）

---

## 11. フェーズ間の差分まとめ（早見表）

* マッチング：

  * P1：ランダム抽出/ランダム分け
  * P2：レート順抽出/交互振り分け
  * P3：マッチングなし（ルームで10人集合）
* ドラフト：

  * P1/P2：マッチング後にドラフト
  * P3：ルーム単体でドラフト可能
  * P3以降はP1/P2もDraft Module経由にリファクタ
* 結果入力・集計：

  * P1：なし
  * P2：あり
  * P3：ドラフトのみ（試合結果は関知しない）
* レーティング：

  * P1：なし
  * P2：あり
  * P3：ドラフトのみ（無関係）

---

## 12. 未確定事項

* なし（本改訂時点で確定）
