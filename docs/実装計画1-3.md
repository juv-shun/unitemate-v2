# フェーズ1.3 実装計画（マッチ成立：ランダム10人）

本書は `docs/開発計画_フェーズ1.md` のフェーズ1.3を、実装レベルまで分解した計画である。
対象は「10人でマッチ成立」「チーム分け（5人ずつ）表示」「先攻/後攻表示」まで。

---

## 1. 前提・参照

- 要件: `docs/要件定義書.md` 8.1
- 画面: `docs/画面設計書_フェーズ1.md` P1-03
- DB: `docs/DB設計書.md`

現状コードでは `users` に `queue_status` / `queue_joined_at` を保持している。
フェーズ1.3ではこの構造を前提に進め、将来的な `queue_entries` への移行を想定した設計にする。

---

## 2. スコープ

### 対象
- 待機ユーザー10人でマッチを成立させる
- チーム分け（5人ずつ）と先攻/後攻を決定する
- 画面にチーム一覧と先攻/後攻を表示する

### 対象外
- ドラフト進行（フェーズ1.4）
- ロビーID共有（フェーズ1.6）
- レートや結果集計（フェーズ2）

---

## 3. データ設計（フェーズ1.3で使う最小）

### 3.1 既存利用（users）
- `queue_status`: "waiting" / "matched" / null
- `queue_joined_at`: timestamp
- 追加候補: `matched_match_id`（string）

### 3.2 新規利用（matches）
`matches/{matchId}`
- `source_type`: "auto"
- `status`: "draft_pending"
- `created_at` / `updated_at`
- `first_team`: "first" / "second"（先攻側を表す）

`matches/{matchId}/members/{memberId}`
- `user_id`
- `role`: "participant"
- `team`: "first" / "second"
- `seat_no`: 1-5
- `joined_at`

### 3.3 将来互換のための補助（任意）
- `users.queue_random`（0〜1の乱数）をインキュー開始時に付与し、抽選の均一性を上げる
- `users.matched_match_id` は「遷移先の確定」用途として必須

---

## 4. マッチング方式（実装方針）

### 4.1 トリガー
以下いずれかを採用する（両方は不要）。

1. **バックエンド（推奨）**
   - Firebase Functions（Python）で定期実行 or 変更検知を行いマッチ成立させる。
   - 競合・二重成立を避けるため、トランザクションで確定する。
2. **フロント主導（暫定）**
   - 一人のクライアントが「マッチング担当」として実行する。
   - 競合や不正のリスクがあるためMVP限定とする。

本計画では **バックエンド（推奨）** を前提に手順を記載する。

### 4.1.1 マッチング実行条件（可変）
要件の「30人」「3分」は **容易に変更可能** にするため、コード内に直書きしない。
管理方法は **環境変数** に統一する。

- 例: `MATCHING_MIN_QUEUE=30` / `MATCHING_MAX_WAIT_SEC=180`

初期値は要件通り「30人」「180秒」とし、運用で調整可能にする。

### 4.2 抽選ロジック
要件は「ランダム10人」。Firestore単体での完全ランダム取得が難しいため、以下のいずれかを採用する。

- **A案（簡易）**: `queue_joined_at` の古い順に最大N件取得 → シャッフルして10人選出  
  - Nは30〜50程度（上限を設ける）
- **B案（推奨）**: `queue_random` を付与し、ランダムキー順で取得 → シャッフルせずに10人選出  
  - 乱数の偏り回避のため `queue_random` はインキュー開始時に必ず更新

フェーズ1.3では **A案で確定** とする（ランダム性は簡易でよい）。

---

## 5. 実装タスク（詳細）

### 5.1 バックエンド（マッチング処理）
1. **待機ユーザー取得**
   - `users` から `queue_status == "waiting"` を取得
   - `queue_joined_at` 昇順で最大N件（A案）
2. **抽選**
   - 配列をシャッフルし10人を確定
   - 10人未満なら終了
3. **チーム分け**
   - 抽選10人を再シャッフル
   - 先頭5人を `team: "first"`、後半5人を `team: "second"`
4. **先攻/後攻の決定**
   - ランダムで `first_team` を "first" / "second" に決定
5. **Firestoreトランザクション**
   - `matches` 新規作成
   - `matches/{matchId}/members` 10件作成
   - `users` の `queue_status="matched"`, `matched_match_id=matchId` へ更新
   - すでに `queue_status != "waiting"` のユーザーが含まれる場合は中断（再抽選）

### 5.2 フロント（マッチ成立の検知）
1. **ユーザードキュメント監視**
   - 既存の `subscribeToQueueStatus` に `matched_match_id` を追加
2. **遷移ルール**
   - `queue_status === "matched"` かつ `matched_match_id` が存在 → P1-03へ遷移
3. **セッション復帰**
   - リロード時も `matched_match_id` を参照しP1-03へ復帰

### 5.3 フロント（P1-03 マッチ成立画面）
1. **データ取得**
   - `matches/{matchId}` の購読
   - `matches/{matchId}/members` の購読（participantのみ）
2. **表示内容**
   - `first_team` に基づく先攻/後攻表示
   - チームごとのユーザー名一覧（seat_no順）
3. **UI状態**
   - 取得中: ローディング
   - データ欠損: エラーメッセージ（P1-08への導線）
4. **次フェーズ導線**
   - 「ドラフト開始」ボタン（フェーズ1.4で有効化）

### 5.4 Firestoreルール
- `users.queue_status` / `matched_match_id` の更新は **バックエンドのみ** に制限
- `matches` と `members` の作成も **バックエンドのみ** に制限
- 参加者は `matches/{matchId}` と `members` を読み取り可能

---

## 6. 画面遷移と状態

1. P1-02（ホーム）でインキュー開始
2. `queue_status: "waiting"` → 10人成立で `queue_status: "matched"`
3. P1-03へ遷移し、チームと先攻/後攻を表示

---

## 7. 例外・エッジケース

- **二重マッチ成立**: トランザクションで `queue_status` を検証し回避
- **取得中にキャンセル**: 既に `queue_status` が変わっていれば再抽選
- **不整合検知**: `members` が10人未満ならP1-08へ誘導
- **再読み込み**: `matched_match_id` から復元

---

## 8. 受け入れ条件への対応表

- 10人分のユーザーが待機中の状態で、マッチが成立する  
  → バックエンドで10人抽選 & `matches` 作成
- 成立後、チーム分け（5人ずつ）が画面に表示される  
  → P1-03で `members` をチーム別表示
- 先攻/後攻が表示される  
  → `matches.first_team` を表示

---

## 9. 手動確認チェックリスト

- 10人インキュー後に `queue_status` が `matched` に変わる
- `matches/{matchId}` が作成されている
- `members` が10人分あり、5人ずつに分かれている
- P1-03に遷移し、チーム/先攻後攻が表示される
- リロードしてもP1-03に復帰する

---

## 10. 成果物

- `matches` / `members` を生成するマッチング処理
- P1-03 マッチ成立画面
- Firestoreルール更新
