# ドラフトピック機能設計書

本書は、ユナメイトのドラフトピック機能（BAN/PICK）の仕様・状態遷移・インターフェース・データ設計・画面要件をまとめる。
`docs/要件定義書.md` の共通ドラフト要件を前提とし、手動作成ドラフトとマッチング後ドラフトの両方で同一ロジックを利用する。

---

## 1. 目的と前提

- ドラフトピックは「単体で実行できるモジュール」として設計する
- 呼び出し元は2種類
  - 手動作成ドラフト（10人集合→ドラフトのみ）
  - マッチング後ドラフト（マッチ成立→ドラフト）
- 呼び出し元が異なるため、開始インターフェースと責務境界を明確化する

---

## 2. ユースケース

### 2.1 ユースケースA: ドラフト単体（手動作成）
- 10人のparticipantが揃ったタイミングでドラフト開始
- 先攻/後攻は試合作成時に確定済み
- ドラフト完了後は「完了」扱い（ロビーIDフローは任意/将来拡張）

### 2.2 ユースケースB: マッチング後ドラフト
- マッチ成立後、チーム分けと先攻/後攻が確定
- ドラフト完了後はロビーID入力フローへ遷移

---

## 3. モジュール境界と責務

### 3.1 ドラフトピックモジュールの責務
- ドラフトセッション生成
- ターン生成（BAN/PICK順固定）
- 担当者ランダム決定
- ターン開始通知
- クリック/リクエスト/確定の進行制御
- 結果確定（BAN/PICK）
- 結果通知と完了イベント

### 3.2 呼び出し元の責務
- 試合作成・参加者管理（10人揃うまで）
- チーム分け・先攻/後攻決定
- ドラフト開始タイミングの決定
- ドラフト完了後の次フロー
  - マッチング後: ロビーID入力
  - 手動作成: 完了 or 再ドラフト（将来）

---

## 4. インターフェース設計（開始/終了）

### 4.1 ドラフト開始インターフェース（共通）
呼び出し元は以下の情報を渡してドラフトを開始する。

必須入力
- draft_id（新規生成）
- match_id
- source_type（manual / auto）
- participants（10人のuser_id）
- teams
  - first_team: user_id[5]
  - second_team: user_id[5]
- started_at
- deadline_sec（15固定）

共通契約
- participantsは10人固定
- teamsは重複無し、合計10人
- teamsは先攻/後攻の割り当てを含む

### 4.2 ドラフト開始インターフェース（ユースケース差分）

手動作成ドラフト
- トリガ: participantが10人揃った時点
- teamsは試合作成時に確定済み
- ロビーIDフローは実行しない

マッチング後ドラフト
- トリガ: マッチ成立直後
- teamsはマッチングロジックで決定
- ドラフト完了後にロビーIDフローへ遷移

### 4.3 ドラフト完了インターフェース（共通）
ドラフト完了時に以下を呼び出し元へ返す。

出力
- draft_id
- bans（先攻/後攻別の6件）
- picks（先攻/後攻別の10件）
- completed_at

呼び出し元の処理
- マッチング後: ロビーID入力フロー開始
- 手動作成: 完了表示（将来: 再ドラフト/継続）

---

## 5. 基本ルール

- 対象人数: 10人（5 vs 5）
- BAN: 3BAN制（各チーム3、計6）
- BAN順: 先攻→後攻→先攻→後攻→先攻→後攻
- PICK順: 先攻1 → 後攻2 → 先攻2 → 後攻2 → 先攻2 → 後攻1
- 重複禁止
  - BAN: 両チーム跨いで同一ポケモンBAN不可
  - PICK: 同一試合で同一ポケモンは1回のみ
- 制限時間: 各BAN/各PICK 15秒
- ターン開始通知: `turn_started(turn_id, deadline_at, server_now)` をターン開始時に1回配信

---

## 6. UI操作仕様（BAN/PICK共通）

- クリック → 確定ボタンの2段階方式
- 確定前はクリック変更可能
- 確定後の取り消しは不可

---

## 7. 自動確定仕様

- 締切後に1秒の猶予を設ける
- 締切+1秒までに「最後のクリック情報」がサーバに到達していれば、それで確定
- クリック情報がなければ空いているポケモンからランダム確定
- 自動確定はペナルティ対象外

---

## 8. 担当者とリクエスト

### 8.1 担当者
- 各BAN/PICKターンの担当者は当該チーム内からランダムに決定
- 代理確定は禁止

### 8.2 リクエスト/承認
- 担当者以外のチームメンバーなら誰でもリクエスト可能
- リクエスト内容はチーム内にブロードキャスト
- 承認できるのは担当者のみ
- 1ターン内で承認できるリクエストは1件のみ
- 承認された瞬間に確定（承認＝確定）
- リクエストは送信後に更新可能（statusはpendingのまま pokemon_id を更新）
- リクエストは取消し可能。取消ししない限り有効

---

## 9. 画面要件（ドラフト画面）

### 9.1 チーム表示
- 画面左: 先攻チーム5人
- 画面右: 後攻チーム5人
- 表示項目
  - ユーザー名
  - 担当中バッジ
  - 仮選択ポケモン（クリック状態）
  - 確定済みBAN/PICK

### 9.2 操作エリア
- ポケモン一覧（検索・フィルタ）
- 選択中ポケモン詳細
- 操作ボタン
  - 担当者: 確定
  - 非担当者: リクエスト送信 / リクエスト更新 / リクエスト取消

### 9.3 結果表示
- 上部: BAN結果（先攻列 / 後攻列）
- 下部: PICK結果（先攻列 / 後攻列）
- チーム別表示（時系列表示はしない）

---

## 10. 状態遷移

- draft_created
- ban_turn_1 〜 ban_turn_6
- pick_turn_1 〜 pick_turn_10
- draft_completed

各ターン共通属性
- turn_id
- phase（ban/pick）
- team（first/second）
- slot_index
- assignee_user_id
- deadline_at
- status（open/closed）
- resolved_by（manual_confirm / request_approved / auto_last_click / auto_random）
- resolved_pokemon_id

---

## 11. データ設計（Firestore想定）

### 11.1 コレクション構成
- draft_sessions
  - turns
    - requests
    - selections
  - actions
- users/{userId}/pick_histories

### 11.2 draft_sessions
- match_id
- status（waiting / in_progress / completed）
- started_at
- completed_at
- expires_at（20日）

### 11.3 turns
- turn_no
- action_type（ban/pick）
- team
- slot_no
- assignee_user_id
- deadline_at
- started_at
- completed_at

### 11.4 actions
- turn_id
- action_type
- team
- pokemon_id
- decided_by（assignee / approved_request / auto_last_click / auto_random）
- decided_user_id
- decided_at

### 11.5 requests
- requester_user_id
- pokemon_id
- status（pending / approved / canceled）
- approved_by_user_id
- created_at
- updated_at

### 11.6 selections
- user_id
- pokemon_id
- updated_at

### 11.7 pick_histories（永続）
- pokemon_id
- picked_at
- match_id
- draft_id
- team
- is_auto

---

## 12. リアルタイムイベント

- draft_started(draft_id)
- turn_started(turn_id, deadline_at, server_now)
- turn_selection_updated(turn_id, user_id, pokemon_id)
- turn_request_created_or_updated(turn_id, request_id, requester_user_id, pokemon_id)
- turn_request_canceled(turn_id, request_id)
- turn_request_approved(turn_id, request_id)
- turn_resolved(turn_id, resolved_by, pokemon_id)
- draft_completed(draft_id, bans, picks)

---

## 13. 保持ポリシー

- draft_sessions / turns / actions / requests / selections は 20日で削除
- users/{userId}/pick_histories は永続保存

---

## 14. マイページ要件（履歴）

- 表示対象: pick_histories のみ
- 表示順: 最新順
- 表示項目: ポケモン名 / 日付 / 試合ID（任意リンク）
