# DB 設計

## テーブル一覧

| テーブル名 | 説明         |
| ---------- | ------------ |
| users      | ユーザー情報 |

## テーブル設計

### users

- **プライマリキー (PK):** `user_id`
- **グローバルセカンダリインデックス (GSI):**
  - `Auth0SubIndex` (パーティションキー: `auth0_sub`)
  - `RankingIndex` (パーティションキー: `ranking_pk` 固定値、ソートキー: `ranking_sk`)

| 項目名                 | 型     | 説明                                                                                 |
| :--------------------- | :----- | :----------------------------------------------------------------------------------- |
| **user_id (PK)**       | string | ユーザーのプライマリキー。Auth0 の`sub`クレーム（Discord のネイティブ ID）と同じ値。 |
| **auth0_sub (GSI PK)** | string | Auth0 のユーザー識別子。GSI `Auth0SubIndex`のパーティションキー。                    |
| discord_username       | string | Discord のユーザー名。                                                               |
| discord_discriminator  | string | Discord の識別子（例: #1234）。新しいユーザー名形式では null になる可能性がある。    |
| discord_avatar_url     | string | Discord のアバター画像の URL。                                                       |
| trainer_name           | string | アプリケーション内で表示されるトレーナー名。                                           |
| twitter_id             | string | Twitter(X) のユーザー ID（例: @example）。nullable。                                |
| preferred_roles        | list   | 希望ロール（上レーン、上学習、中央、下レーン、下学習）の配列。                         |
| bio                    | string | ひとこと（自己紹介文）。最大500文字。nullable。                                       |
| favorite_pokemon       | list   | 得意なポケモンのIDの配列。最大5つまで選択可能。nullable。                             |
| rate                   | number | 現在のレート。初期値は 1500。                                                        |
| max_rate               | number | 最高レート。初期値は 1500。                                                          |
| match_count            | number | 総試合数。                                                                           |
| win_count              | number | 勝利数。                                                                             |
| last_match_at          | number | 最終試合日時 (unixtime)。ランキングの対象判定に使用。未試合の場合は null。             |
| created_at             | number | レコード作成日時 (unixtime)。                                                        |
| updated_at             | number | レコード最終更新日時 (unixtime)。                                                    |
| ranking_pk (GSI PK)    | string | ランキング用GSI `RankingIndex` のパーティションキー。常に固定値 `RANKING#GLOBAL`。    |
| ranking_sk (GSI SK)    | string | ランキング用GSIのソートキー。`R#<rate_padded>#U#<user_id>` 形式の文字列。             |

#### RankingIndex の設計メモ

- 目的: ランキングページAPI（`GET /api/rankings`）でレート降順上位N件（最大200）を高速取得する。
- `ranking_pk`: すべてのユーザーに対し固定値 `RANKING#GLOBAL` を設定し、単一パーティションで上位を取得。
- `ranking_sk`: 辞書順でレート降順になるように、レートを固定幅0埋めで文字列化して連結。
  - 形式: `R#<rate_padded>#U#<user_id>`
  - `rate_padded`: レートを整数で固定幅0埋め（例: 6桁 `001780`）。レートが小数の場合は×100などで整数化してから0埋め。
  - `user_id` を末尾に含めることで、同率時もキーが一意になり、安定した順序が得られる。
- 取得方法: GSI `RankingIndex` を `ScanIndexForward=false` かつ `Limit=200` でQueryし、必要項目を投影(INCLUDE)する。
- 更新タイミング: ユーザー作成時および試合結果反映による `rate` 変更時に `ranking_sk` を再計算・更新する。
