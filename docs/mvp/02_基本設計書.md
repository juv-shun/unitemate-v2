# 基本設計書

## システム構成

### システム構成図

![システム構成図](img/unitemate-v2.drawio.png)

#### バックエンド処理の役割分担

Netlify Functions と、AWS Lambda にて、バックエンド処理が可能。
上記２つは、以下の役割分担とする。

- Netlify Functions
  - フロントエンドから直接呼び出し可能
  - DB へのアクセスが不可能
  - Netlify Identity を使用して、ユーザー認証が可能。
  - **AWS Lambada から認証機能を切り離し、フロントエンドと AWS Lambda 間の中間サーバとして扱う。**
- AWS Lambda
  - DB へのアクセスが可能
  - **Netlify Functions を橋渡し役にすることで、リクエスト元の権限を気にせず、管理者権限としてバックエンド処理を実行する。**

## 画面設計

### 画面一覧

| 画面名           | 要ログイン | 説明                       |
| ---------------- | ---------- | -------------------------- |
| トップページ     | いいえ     | Discord でログインする画面 |
| マッチングページ | はい       | マッチングを開始する画面   |
| マイページ       | はい       | ユーザーのマイページ       |
| ランキングページ | いいえ     | ランキングを表示する画面   |
| 使い方ページ     | いいえ     | 使い方を説明する画面       |

要ログインページにて、未ログインでアクセスした場合、トップページにリダイレクトする。

## DB 設計

### テーブル一覧

| テーブル名  | 説明             |
| ----------- | ---------------- |
| users       | ユーザー情報     |
| match_queue | マッチングキュー |
| matches     | マッチング情報   |

### テーブル設計

#### users

| 項目名            | 型     | 説明           |
| ----------------- | ------ | -------------- |
| user_id           | string | ユーザー ID    |
| discord_id        | string | Discord ID     |
| trainer_name      | string | テーブル名     |
| twitter_id        | string | Twitter ID     |
| desired_roles     | list   | 希望ロール     |
| description       | string | 自己紹介文     |
| preferred_pokemon | list   | 得意ポケモン   |
| badges            | list   | 勲章           |
| rate              | number | レート         |
| max_rate          | number | 最大レート     |
| match_count       | number | 試合回数       |
| win_count         | number | 勝ち数         |
| penalty_count     | number | ペナルティ数   |
| match_history     | list   | 試合履歴       |
| last_match_at     | number | 最後の試合日時 |

#### match_queue

| 項目名  | 型     | 説明        |
| ------- | ------ | ----------- |
| user_id | string | ユーザー ID |
| rate    | number | レート      |

#### matches

| 項目名       | 型     | 説明                   |
| ------------ | ------ | ---------------------- |
| match_id     | string | マッチング ID          |
| matched_at   | number | マッチング日時         |
| status       | string | マッチング状態         |
| result       | string | マッチング結果         |
| users        | map    | ユーザー情報           |
| user_reports | list   | ユーザーからの試合報告 |
