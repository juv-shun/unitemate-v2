# ドラフトピック機能実装計画

本書は、ドラフトピック機能の実装をフェーズ分割し、各フェーズのタスクを
「画面 / DB / API / リアルタイム」観点と「ユースケース時系列」の両方で整理する。

---

## 1. フェーズ分割（確定）

1. ユースケースA: 手動作成 → 10人集合 → ドラフト開始 → ドラフト完了
2. ドラフトピックモジュールの内部品質向上（制約・自動確定・リクエスト更新など）
3. ユースケースB: マッチング → ドラフトモジュール呼び出し → 完了 → ロビーID遷移

---

## 2. フェーズ1（MVP）

### 2.1 方針（削るもの）
- リクエスト機能（送信/更新/取消/承認）
- 自動確定（締切+1秒猶予/ランダム）
- 仮選択のリアルタイム共有（selections）
- pick_histories の永続保存

### 2.2 残す最低限
- BAN/PICK順の固定
- 先攻/後攻の固定（画面左右）
- 担当者の直接確定のみ
- 確定結果の同期（actions）
- ドラフト完了イベント

### 2.3 フェーズ1-A（ドラフト開始前）

#### 画面
- 手動作成ルーム作成画面（participant追加）
- 参加者一覧（10人揃い確認）

#### DB
- matches / members
- 10人揃いで draft_sessions 作成（status=waiting）

#### API
- ルーム作成 / 参加 / 退出
- 参加者10人揃い判定
- ドラフト開始トリガ（draft_sessions生成・turns生成）

#### リアルタイム
- 参加者更新通知
- draft_started

### 2.4 フェーズ1-B（ドラフト開始後）

#### 画面
- ドラフト画面（最小UI）
  - 左: 先攻5人 / 右: 後攻5人
  - 担当者のみ確定ボタン表示
  - BAN/PICK結果表示

#### DB
- draft_sessions / turns / actions

#### API
- ターン開始通知
- 担当者確定（actions追加）
- ドラフト完了通知

#### リアルタイム
- turn_started
- turn_resolved
- draft_completed

### 2.5 ユースケース時系列（フェーズ1）
1) 手動作成ルーム作成
2) 参加者10人揃い
3) ドラフト開始（turns生成/担当決定）
4) BAN/PICK進行（担当者確定のみ）
5) ドラフト完了

---

## 3. フェーズ2（モジュール強化）

### 3.1 追加機能
- リクエスト送信/更新/取消/承認
- 自動確定（締切+1秒猶予/ランダム）
- 仮選択の共有（selections）
- pick_histories 永続保存

### 3.2 観点別タスク

#### 画面
- リクエスト状態表示
- リクエスト送信/更新/取消UI
- 残り時間表示（server_now補正）

#### DB
- turns/{turnId}/requests
- turns/{turnId}/selections
- users/{userId}/pick_histories

#### API
- リクエスト作成/更新/取消/承認
- 自動確定ロジック
- PICK確定時の履歴保存

#### リアルタイム
- turn_selection_updated
- turn_request_created_or_updated
- turn_request_canceled
- turn_request_approved

### 3.3 ユースケース時系列
1) リクエスト送信/更新/取消
2) 承認→確定
3) 自動確定の適用
4) pick_histories 保存

---

## 4. フェーズ3（マッチング連携）

### 4.1 追加機能
- マッチング成立後にドラフト開始を呼び出す
- ドラフト完了後にロビーIDフローへ遷移

### 4.2 観点別タスク

#### 画面
- マッチング完了 → ドラフト画面遷移
- ドラフト完了 → ロビーID入力画面遷移

#### DB
- matches のステータス遷移連携
- lobby_infos 連携

#### API
- マッチング完了イベント → ドラフト開始
- ドラフト完了イベント → ロビーID入力開始

#### リアルタイム
- マッチング完了通知
- ドラフト開始通知
- ドラフト完了通知

### 4.3 ユースケース時系列
1) マッチ成立
2) チーム分け/先攻後攻確定
3) ドラフトモジュール呼び出し
4) ドラフト完了
5) ロビーID入力フロー開始

